<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeWise - Stock Screener</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-cyan-400">üìä Stock Screener</h1>
                <p class="text-gray-400">High-confidence BUY/SELL signals for penny & medium stocks</p>
            </div>
            <div class="flex gap-3 items-center">
                <!-- User Info -->
                <div id="userInfo" class="hidden">
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <div class="text-sm text-gray-400">Logged in as</div>
                            <div id="userEmail" class="text-sm font-semibold"></div>
                        </div>
                        <button id="logoutBtn" class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-sm">
                            Logout
                        </button>
                    </div>
                </div>
                <!-- Login Button -->
                <a id="loginBtn" href="/login.html" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded">
                    Login
                </a>
                <a href="/" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded">
                    ‚Üê Dashboard
                </a>
                <button id="refreshBtn" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <!-- Scan Controls -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Stocks to Scan</label>
                    <select id="limitSelect" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        <option value="25">25 - Quick Scan</option>
                        <option value="50" selected>50 - Balanced</option>
                        <option value="100">100 - Comprehensive</option>
                        <option value="200">200 - Deep Scan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Min Confidence</label>
                    <select id="confidenceSelect" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        <option value="60">60% - Moderate</option>
                        <option value="70" selected>70% - High</option>
                        <option value="80">80% - Very High</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Action Filter</label>
                    <select id="actionFilter" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        <option value="all">All Signals</option>
                        <option value="BUY" selected>BUY Only</option>
                        <option value="SELL">SELL Only</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="scanBtn" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-semibold">
                        üîç Scan Stocks
                    </button>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-400">
                üí° Scans random selection from 500+ NSE stocks. Each scan gives different results for broader coverage.
            </div>
        </div>

        <!-- Authentication Status -->
        <div id="authStatus" class="bg-gray-800 rounded-lg p-4 mb-6 border-l-4 border-yellow-400">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-yellow-400">üîê Market Data Authentication</h3>
                    <p id="authStatusText" class="text-gray-300 text-sm">Checking authentication status...</p>
                </div>
                <button id="fyersAuthBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm hidden">
                    Connect Fyers Account
                </button>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="statusBar" class="bg-gray-800 rounded-lg p-4 mb-6 hidden">
            <div class="flex justify-between items-center">
                <div class="flex gap-6">
                    <div>
                        <div class="text-gray-400 text-sm">Stocks Scanned</div>
                        <div id="stocksScanned" class="text-2xl font-bold text-blue-400">0</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">Total Signals</div>
                        <div id="totalSignals" class="text-2xl font-bold text-cyan-400">0</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">BUY Signals</div>
                        <div id="buyCount" class="text-2xl font-bold text-green-400">0</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">SELL Signals</div>
                        <div id="sellCount" class="text-2xl font-bold text-red-400">0</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-gray-400 text-sm">Last Scan</div>
                    <div id="scanTime" class="text-sm">--</div>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingDiv" class="text-center py-12 hidden">
            <div class="animate-spin inline-block w-12 h-12 border-4 border-cyan-400 border-t-transparent rounded-full"></div>
            <p class="mt-4 text-gray-400" id="loadingText">Scanning stocks... This may take 20-60 seconds</p>
            <p class="mt-2 text-sm text-gray-500" id="scanProgress">Analyzing: 0 / 0 stocks</p>
        </div>

        <!-- Signals Grid -->
        <div id="signalsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Stock cards will be inserted here -->
        </div>

        <!-- No Signals Message -->
        <div id="noSignals" class="text-center py-12 hidden">
            <div class="text-6xl mb-4">üì≠</div>
            <h3 class="text-xl text-gray-400">No signals found</h3>
            <p class="text-gray-500 mt-2">Try adjusting filters or scan again later</p>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin; // Use current origin (works with localhost and ngrok)
        let currentSignals = [];
        let authToken = null;
        let currentUser = null;

        // Elements
        const scanBtn = document.getElementById('scanBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const limitSelect = document.getElementById('limitSelect');
        const confidenceSelect = document.getElementById('confidenceSelect');
        const actionFilter = document.getElementById('actionFilter');
        const loadingDiv = document.getElementById('loadingDiv');
        const statusBar = document.getElementById('statusBar');
        const signalsGrid = document.getElementById('signalsGrid');
        const noSignals = document.getElementById('noSignals');
        const userInfo = document.getElementById('userInfo');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmail = document.getElementById('userEmail');

        // Initialize authentication
        function initAuth() {
            authToken = localStorage.getItem('auth_token');
            const userStr = localStorage.getItem('user');
            
            if (authToken && userStr) {
                currentUser = JSON.parse(userStr);
                userEmail.textContent = currentUser.email;
                userInfo.classList.remove('hidden');
                loginBtn.classList.add('hidden');
            } else {
                userInfo.classList.add('hidden');
                loginBtn.classList.remove('hidden');
            }
        }

        // Logout
        logoutBtn.addEventListener('click', async () => {
            if (authToken) {
                try {
                    await fetch(`${API_BASE}/api/auth/logout?authorization=Bearer ${authToken}`, {
                        method: 'POST'
                    });
                } catch (error) {
                    console.log('Logout error:', error);
                }
            }
            
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            window.location.reload();
        });

        // Scan stocks
        async function scanStocks() {
            // Check authentication first
            if (!authToken) {
                alert('‚ùå Login required to use the stock screener.\n\nPlease login to scan stocks and save your results.');
                window.location.href = '/login.html';
                return;
            }

            const limit = limitSelect.value;
            const minConfidence = confidenceSelect.value;

            try {
                showLoading(true);
                
                // Build URL and send auth token in header (best practice)
                const url = `${API_BASE}/screener/scan?limit=${limit}&min_confidence=${minConfidence}&randomize=true`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    currentSignals = data.signals;
                    updateStatusBar(data);
                    displaySignals();
                    
                    // Show save status
                    if (data.saved) {
                        console.log('‚úÖ Scan results saved to your account!');
                    } else {
                        console.log('‚ö†Ô∏è Scan completed but failed to save results');
                    }
                } else if (response.status === 401 && data.detail?.error === 'fyers_auth_required') {
                    // Fyers authentication required
                    const authModal = document.createElement('div');
                    authModal.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4">
                                <div class="text-center">
                                    <div class="text-6xl mb-4">üîê</div>
                                    <h2 class="text-xl font-bold text-cyan-400 mb-4">Fyers Authentication Required</h2>
                                    <p class="text-gray-300 mb-6">To fetch live market data and scan stocks, you need to connect your Fyers account.</p>
                                    <div class="flex gap-3 justify-center">
                                        <button onclick="openFyersAuth('${data.detail.auth_url}'); this.closest('.fixed').remove();" 
                                                class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white">
                                            Connect Fyers Account
                                        </button>
                                        <button onclick="this.closest('.fixed').remove()" 
                                                class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(authModal);
                } else if (response.status === 401 && data.detail?.error === 'fyers_token_expired') {
                    // Fyers token expired
                    const expiredModal = document.createElement('div');
                    expiredModal.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4">
                                <div class="text-center">
                                    <div class="text-6xl mb-4">‚è∞</div>
                                    <h2 class="text-xl font-bold text-yellow-400 mb-4">Authentication Expired</h2>
                                    <p class="text-gray-300 mb-6">Your Fyers authentication has expired (tokens last 24 hours). Please re-authenticate to continue.</p>
                                    <div class="flex gap-3 justify-center">
                                        <button onclick="openFyersAuth('${data.detail.auth_url}'); this.closest('.fixed').remove();" 
                                                class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-white">
                                            Re-authenticate
                                        </button>
                                        <button onclick="this.closest('.fixed').remove()" 
                                                class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(expiredModal);
                } else if (response.status === 401) {
                    // Supabase authentication expired
                    alert('Your session has expired. Please login again.');
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login.html';
                } else {
                    // Other errors
                    const errorMsg = data.detail?.message || data.detail || data.message || 'Unknown error';
                    alert('Error scanning stocks: ' + errorMsg);
                }
            } catch (error) {
                console.error('Scan error:', error);
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    alert('Session expired. Please login again.');
                    window.location.href = '/login.html';
                } else {
                    alert('Failed to scan stocks. Check console for details.');
                }
            } finally {
                showLoading(false);
            }
        }

        // Update status bar
        function updateStatusBar(data) {
            document.getElementById('stocksScanned').textContent = data.stocks_scanned || 0;
            document.getElementById('totalSignals').textContent = data.total_signals;
            document.getElementById('buyCount').textContent = data.buy_signals;
            document.getElementById('sellCount').textContent = data.sell_signals;
            document.getElementById('scanTime').textContent = new Date(data.scan_time).toLocaleTimeString();
            statusBar.classList.remove('hidden');
        }

        // Display signals
        function displaySignals() {
            const action = actionFilter.value;
            let signals = [];

            if (action === 'all') {
                signals = [...currentSignals.buy, ...currentSignals.sell];
            } else if (action === 'BUY') {
                signals = currentSignals.buy || [];
            } else {
                signals = currentSignals.sell || [];
            }

            // Sort by confidence
            signals.sort((a, b) => b.confidence - a.confidence);

            if (signals.length === 0) {
                signalsGrid.innerHTML = '';
                noSignals.classList.remove('hidden');
                return;
            }

            noSignals.classList.add('hidden');
            signalsGrid.innerHTML = signals.map(signal => createStockCard(signal)).join('');
        }

        // Create stock card
        function createStockCard(signal) {
            const isBuy = signal.action === 'BUY';
            const borderColor = isBuy ? 'border-green-500' : 'border-red-500';
            const actionBg = isBuy ? 'bg-green-600' : 'bg-red-600';
            const confidenceColor = signal.confidence >= 80 ? 'text-green-400' : signal.confidence >= 70 ? 'text-cyan-400' : 'text-yellow-400';

            const changeColor = signal.change_pct >= 0 ? 'text-green-400' : 'text-red-400';

            return `
                <div class="bg-gray-800 rounded-lg border-2 ${borderColor} p-4 hover:bg-gray-750 transition">
                    <!-- Header -->
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-bold">${signal.name}</h3>
                            <span class="text-xs text-gray-400">‚Çπ${signal.current_price.toFixed(2)}</span>
                        </div>
                        <span class="${actionBg} px-3 py-1 rounded font-semibold text-sm">
                            ${signal.action}
                        </span>
                    </div>

                    <!-- Price & Confidence -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <div class="text-gray-400 text-xs">Current Price</div>
                            <div class="text-xl font-bold">‚Çπ${signal.current_price.toFixed(2)}</div>
                            <div class="${changeColor} text-xs">${signal.change_pct > 0 ? '+' : ''}${signal.change_pct}%</div>
                        </div>
                        <div>
                            <div class="text-gray-400 text-xs">Confidence</div>
                            <div class="text-xl font-bold ${confidenceColor}">${signal.confidence}%</div>
                            <div class="text-xs text-gray-500">${signal.confidence >= 80 ? 'VERY HIGH' : signal.confidence >= 70 ? 'HIGH' : 'MODERATE'}</div>
                        </div>
                    </div>

                    <!-- Targets -->
                    <div class="border-t border-gray-700 pt-3 mb-3">
                        <div class="text-xs text-gray-400 mb-2">TARGETS & STOP LOSS</div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="bg-green-900/30 rounded p-2">
                                <div class="text-gray-400">Target 1</div>
                                <div class="font-semibold">‚Çπ${signal.targets.target_1.toFixed(2)}</div>
                                <div class="text-green-400">+${((signal.targets.target_1/signal.current_price - 1) * 100).toFixed(1)}%</div>
                            </div>
                            <div class="bg-green-900/30 rounded p-2">
                                <div class="text-gray-400">Target 2</div>
                                <div class="font-semibold">‚Çπ${signal.targets.target_2.toFixed(2)}</div>
                                <div class="text-green-400">+${((signal.targets.target_2/signal.current_price - 1) * 100).toFixed(1)}%</div>
                            </div>
                            <div class="bg-red-900/30 rounded p-2">
                                <div class="text-gray-400">Stop Loss</div>
                                <div class="font-semibold">‚Çπ${signal.targets.stop_loss.toFixed(2)}</div>
                                <div class="text-red-400">${((signal.targets.stop_loss/signal.current_price - 1) * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicators -->
                    <div class="border-t border-gray-700 pt-3 mb-3">
                        <div class="text-xs text-gray-400 mb-2">TECHNICAL INDICATORS</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-500">RSI:</span>
                                <span class="font-semibold">${signal.indicators.rsi}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">5D Momentum:</span>
                                <span class="font-semibold ${signal.indicators.momentum_5d >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${signal.indicators.momentum_5d > 0 ? '+' : ''}${signal.indicators.momentum_5d}%
                                </span>
                            </div>
                            <div>
                                <span class="text-gray-500">SMA 5:</span>
                                <span class="font-semibold">‚Çπ${signal.indicators.sma_5.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Volume:</span>
                                <span class="font-semibold ${signal.indicators.volume_surge ? 'text-orange-400' : ''}">
                                    ${signal.indicators.volume_surge ? 'üî• SURGE' : 'Normal'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Reasons -->
                    <div class="border-t border-gray-700 pt-3">
                        <div class="text-xs text-gray-400 mb-2">SIGNAL REASONS</div>
                        <div class="space-y-1">
                            ${signal.reasons.map(reason => `
                                <div class="text-xs bg-gray-700/50 rounded px-2 py-1">${reason}</div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Show/hide loading
        function showLoading(show) {
            loadingDiv.classList.toggle('hidden', !show);
            signalsGrid.classList.toggle('hidden', show);
            statusBar.classList.toggle('hidden', show);
        }

        // Open Fyers authentication in popup
        function openFyersAuth(authUrl) {
            // Get fresh auth token from localStorage
            const currentAuthToken = localStorage.getItem('auth_token');
            console.log('üöÄ Opening Fyers auth popup with authToken:', currentAuthToken ? 'Present' : 'Missing');
            
            if (!currentAuthToken) {
                alert('Please login to TradeWise first!');
                window.location.href = '/login.html';
                return;
            }
            
            // Check if we're running on the same domain (ngrok)
            const isNgrokDomain = window.location.hostname.includes('ngrok-free.app');
            
            if (isNgrokDomain) {
                console.log('üåê Using ngrok domain - same-origin popup communication enabled');
                // For same-domain, we can pass the auth token via URL fragment for easier access
                const authUrlWithToken = `${authUrl}#token=${currentAuthToken}`;
                const popup = window.open(authUrlWithToken, 'fyersAuth', 'width=600,height=700,scrollbars=yes,resizable=yes');
                
                // Listen for messages from popup (same-origin, should work perfectly)
                const messageHandler = (event) => {
                    console.log('üì® Received message in parent:', event.data);
                    
                    if (event.data.type === 'get_auth_token') {
                        console.log('üîë Popup requesting auth token');
                        popup.postMessage({ 
                            type: 'auth_token_response', 
                            token: currentAuthToken 
                        }, '*');
                        console.log('üì§ Sent auth token response to popup');
                    } else if (event.data.type === 'fyers_auth_success') {
                        console.log('üéâ Fyers authentication successful!');
                        checkFyersAuth(); // Refresh auth status
                        window.removeEventListener('message', messageHandler);
                    } else if (event.data.type === 'fyers_auth_error') {
                        console.error('‚ùå Fyers authentication failed:', event.data.error);
                        window.removeEventListener('message', messageHandler);
                    }
                };
                
                window.addEventListener('message', messageHandler);
                console.log('üëÇ Added message listener for same-origin popup communication');
                
                // Clean up if popup is closed manually
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        window.removeEventListener('message', messageHandler);
                        console.log('üö™ Popup closed, cleaned up listeners');
                    }
                }, 1000);
            } else {
                console.log('üè† Using localhost domain - opening popup with cross-origin fallback');
                const popup = window.open(authUrl, 'fyersAuth', 'width=600,height=700,scrollbars=yes,resizable=yes');
                
                // For localhost, use the existing cross-origin handling
                const messageHandler = (event) => {
                    console.log('üì® Received message in parent:', event.data);
                    
                    if (event.data.type === 'get_auth_token') {
                        console.log('üîë Popup requesting auth token');
                        popup.postMessage({ 
                            type: 'auth_token_response', 
                            token: currentAuthToken 
                        }, '*');
                        console.log('üì§ Sent auth token response to popup');
                    } else if (event.data.type === 'fyers_auth_success') {
                        console.log('üéâ Fyers authentication successful!');
                        checkFyersAuth(); // Refresh auth status
                        window.removeEventListener('message', messageHandler);
                    } else if (event.data.type === 'fyers_auth_error') {
                        console.error('‚ùå Fyers authentication failed:', event.data.error);
                        window.removeEventListener('message', messageHandler);
                    }
                };
                
                window.addEventListener('message', messageHandler);
                console.log('üëÇ Added message listener for cross-origin popup communication');
                
                // Clean up if popup is closed manually
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        window.removeEventListener('message', messageHandler);
                        console.log('üö™ Popup closed, cleaned up listeners');
                    }
                }, 1000);
            }
        }

        // Check Fyers authentication status
        async function checkFyersAuth() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/fyers/token`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const authStatusDiv = document.getElementById('authStatus');
                const authStatusText = document.getElementById('authStatusText');
                const fyersAuthBtn = document.getElementById('fyersAuthBtn');
                
                if (response.ok) {
                    // Fyers token exists
                    authStatusDiv.className = 'bg-gray-800 rounded-lg p-4 mb-6 border-l-4 border-green-400';
                    authStatusText.innerHTML = '‚úÖ Market data access ready - your Fyers account is connected.';
                    fyersAuthBtn.classList.add('hidden');
                } else {
                    // No Fyers token
                    authStatusDiv.className = 'bg-gray-800 rounded-lg p-4 mb-6 border-l-4 border-yellow-400';
                    authStatusText.innerHTML = '‚ö†Ô∏è Market data access required - click to connect your Fyers account.';
                    fyersAuthBtn.classList.remove('hidden');
                    fyersAuthBtn.onclick = async () => {
                        try {
                            const response = await fetch(`${API_BASE}/auth/url`);
                            const data = await response.json();
                            
                            // Open in popup for better UX
                            const popup = window.open(
                                data.auth_url, 
                                'fyersAuth', 
                                'width=600,height=700,scrollbars=yes,resizable=yes'
                            );
                            
                            // Check for popup completion
                            const checkClosed = setInterval(() => {
                                if (popup.closed) {
                                    clearInterval(checkClosed);
                                    // Refresh auth status after popup closes
                                    setTimeout(() => checkFyersAuth(), 1000);
                                }
                            }, 1000);
                            
                        } catch (error) {
                            console.error('Auth error:', error);
                            alert('Failed to start authentication. Please try again.');
                        }
                    };
                }
            } catch (error) {
                console.error('Auth check error:', error);
                const authStatusText = document.getElementById('authStatusText');
                authStatusText.innerHTML = '‚ùå Unable to check authentication status.';
            }
        }

        // Event listeners
        scanBtn.addEventListener('click', scanStocks);
        refreshBtn.addEventListener('click', scanStocks);
        actionFilter.addEventListener('change', displaySignals);

        // Initialize authentication on page load
        initAuth();
        
        // Check Fyers auth status
        if (authToken) {
            checkFyersAuth();
        }
        
        // Redirect to login if not authenticated
        if (!authToken) {
            console.log('‚ö†Ô∏è Authentication required to use Stock Screener');
            alert('üîí Stock Screener requires authentication.\n\nPlease login to access the scanner and save your results.');
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 1500);
        }

        // Auto-refresh disabled - manual scan only
        // To enable auto-refresh, uncomment the code below:
        /*
        setInterval(() => {
            if (currentSignals.buy || currentSignals.sell) {
                console.log('Auto-refreshing signals...');
                scanStocks();
            }
        }, 5 * 60 * 1000);
        */

        // Check for scan ID in URL parameter
        async function loadScanFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const scanId = urlParams.get('scan') || localStorage.getItem('view_scan_id');
            
            if (scanId) {
                console.log('Loading scan:', scanId);
                localStorage.removeItem('view_scan_id'); // Clear after reading
                
                if (!authToken) {
                    alert('Please login to view saved scans');
                    return;
                }
                
                try {
                    // Note: We would need a new endpoint to fetch a specific scan
                    // For now, we'll fetch latest and check if it matches
                    const response = await fetch(`${API_BASE}/screener/history?limit=10`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const scan = data.scans.find(s => s.scan_id === scanId);
                        
                        if (scan) {
                            // Show notification that this is a saved scan
                            const statusBar = document.querySelector('.bg-gray-800.rounded-lg');
                            if (statusBar) {
                                const notice = document.createElement('div');
                                notice.className = 'bg-blue-900/50 border border-blue-500/50 rounded p-3 mb-4 text-sm';
                                notice.innerHTML = `
                                    <span class="text-blue-400">üìã Viewing saved scan from ${new Date(scan.scan_time).toLocaleString()}</span>
                                    <button onclick="this.parentElement.remove()" class="float-right text-gray-400 hover:text-white">‚úï</button>
                                `;
                                statusBar.parentElement.insertBefore(notice, statusBar);
                            }
                            
                            console.log('‚úÖ Loaded saved scan:', scan);
                            // You can add more logic here to display the scan results
                        }
                    }
                } catch (error) {
                    console.error('Error loading scan:', error);
                }
            }
        }
        
        // Load scan if URL parameter is present
        if (authToken) {
            loadScanFromURL();
        }

        // Initial message
        if (authToken) {
            console.log('‚úÖ Logged in. Scan results will be automatically saved to your account.');
            console.log('Stock Screener ready. Click "Scan Stocks" to begin.');
        }
    </script>
</body>
</html>
