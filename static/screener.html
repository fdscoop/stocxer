<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TradeWise - Stock Screener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/mobile.css" rel="stylesheet">
    <style>
        /* Screener-specific mobile styles */
        @media screen and (max-width: 767px) {
            .container {
                padding: 8px !important;
            }

            .screener-header {
                flex-direction: column !important;
                gap: 12px !important;
            }

            .screener-header>div:first-child {
                text-align: center;
            }

            .screener-header .flex {
                flex-wrap: wrap !important;
                justify-content: center !important;
            }

            .status-bar-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }

            .status-bar-grid>div {
                text-align: center !important;
                padding: 8px !important;
            }

            #signalsGrid {
                gap: 8px !important;
            }

            .signal-card {
                padding: 12px !important;
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto px-4 py-6">
        <!-- Header - Mobile Optimized -->
        <div class="screener-header flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-cyan-400">üìä Stock Screener</h1>
                <p class="text-gray-400 text-sm md:text-base">High-confidence signals for your portfolio</p>
            </div>
            <div class="flex gap-2 md:gap-3 items-center flex-wrap justify-center">
                <!-- User Info -->
                <div id="userInfo" class="hidden">
                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="text-right hidden md:block">
                            <div class="text-xs text-gray-400">Logged in as</div>
                            <div id="userEmail" class="text-sm font-semibold text-cyan-400"></div>
                        </div>
                        <button id="logoutBtn"
                            class="px-2 md:px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-xs md:text-sm">
                            Logout
                        </button>
                    </div>
                </div>
                <!-- Login Button -->
                <a id="loginBtn" href="/login.html"
                    class="px-3 md:px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                    Login
                </a>
                <a href="/" class="px-3 md:px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                    ‚Üê Dashboard
                </a>
            </div>
        </div>

        <!-- User Dashboard Indicator -->
        <div id="userDashboardBanner"
            class="bg-gradient-to-r from-cyan-900/30 to-blue-900/30 rounded-lg p-3 mb-4 border border-cyan-500/30 hidden">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-2">
                    <span class="text-lg">üë§</span>
                    <span class="text-sm text-cyan-400">Your Personal Scanner</span>
                    <span id="userEmailBanner" class="text-xs text-gray-400"></span>
                </div>
                <div class="text-xs text-gray-400">
                    Results are saved to your account
                </div>
            </div>
        </div>

        <!-- Stock Search Section -->
        <div class="bg-gray-800 rounded-lg p-3 md:p-4 mb-4 md:mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm md:text-base font-semibold text-cyan-400">üîç Search & Select Stocks</h3>
                <button id="clearSelectedBtn" class="text-xs text-gray-400 hover:text-white hidden">
                    Clear All
                </button>
            </div>

            <!-- Search Input -->
            <div class="relative mb-3">
                <input type="text" id="stockSearch"
                    placeholder="Type stock name or symbol (e.g., 'Reliance' or 'TCS')..."
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:border-cyan-500 focus:outline-none"
                    autocomplete="off" />
                <div id="searchResults"
                    class="absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded max-h-64 overflow-y-auto hidden">
                </div>
            </div>

            <!-- Selected Stocks Display -->
            <div id="selectedStocksContainer" class="hidden">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs text-gray-400">Selected: <span id="selectedCount">0</span> stocks</span>
                </div>
                <div id="selectedStocks" class="flex flex-wrap gap-2"></div>
                <button id="scanSelectedBtn"
                    class="mt-3 w-full px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded font-semibold text-sm">
                    üéØ Scan Selected Stocks
                </button>
            </div>

            <div class="mt-2 text-xs text-gray-500">
                üí° Search and select specific stocks to scan, or use the regular scan below for random stocks.
            </div>
        </div>

        <!-- Scan Controls - Compact for mobile -->
        <div class="bg-gray-800 rounded-lg p-3 md:p-4 mb-4 md:mb-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4">
                <div>
                    <label class="block text-xs md:text-sm text-gray-400 mb-1 md:mb-2">Stocks to Scan</label>
                    <select id="limitSelect"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 md:px-3 py-2 text-sm">
                        <option value="25">25 - Quick</option>
                        <option value="50" selected>50 - Balanced</option>
                        <option value="100">100 - Deep</option>
                        <option value="200">200 - Full</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs md:text-sm text-gray-400 mb-1 md:mb-2">Min Confidence</label>
                    <select id="confidenceSelect"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 md:px-3 py-2 text-sm">
                        <option value="60">60%</option>
                        <option value="70" selected>70%</option>
                        <option value="80">80%</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs md:text-sm text-gray-400 mb-1 md:mb-2">Action</label>
                    <select id="actionFilter"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 md:px-3 py-2 text-sm">
                        <option value="all">All</option>
                        <option value="BUY" selected>BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div class="flex items-end col-span-2 md:col-span-1">
                    <button id="scanBtn"
                        class="w-full px-3 md:px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-semibold text-sm md:text-base">
                        üîç Scan Stocks
                    </button>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500 hidden md:block">
                üí° Each scan analyzes a random selection from 500+ NSE stocks for broader coverage.
            </div>
        </div>

        <!-- Authentication Status - Compact -->
        <div id="authStatus" class="bg-gray-800 rounded-lg p-3 md:p-4 mb-4 md:mb-6 border-l-4 border-yellow-400">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
                <div>
                    <h3 class="text-base md:text-lg font-semibold text-yellow-400">üîê Market Data</h3>
                    <p id="authStatusText" class="text-gray-300 text-xs md:text-sm">Checking status...</p>
                </div>
                <button id="fyersAuthBtn"
                    class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-xs md:text-sm hidden">
                    Connect Fyers
                </button>
            </div>
        </div>

        <!-- Status Bar - Mobile Grid -->
        <div id="statusBar" class="bg-gray-800 rounded-lg p-3 md:p-4 mb-4 md:mb-6 hidden">
            <div class="status-bar-grid flex flex-wrap md:flex-nowrap justify-between items-center gap-3 md:gap-6">
                <div class="bg-gray-700/50 rounded-lg p-2 md:p-3 flex-1 min-w-[70px] text-center">
                    <div class="text-gray-400 text-xs">Scanned</div>
                    <div id="stocksScanned" class="text-xl md:text-2xl font-bold text-blue-400">0</div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-2 md:p-3 flex-1 min-w-[70px] text-center">
                    <div class="text-gray-400 text-xs">Total</div>
                    <div id="totalSignals" class="text-xl md:text-2xl font-bold text-cyan-400">0</div>
                </div>
                <div class="bg-green-900/30 rounded-lg p-2 md:p-3 flex-1 min-w-[70px] text-center">
                    <div class="text-gray-400 text-xs">BUY</div>
                    <div id="buyCount" class="text-xl md:text-2xl font-bold text-green-400">0</div>
                </div>
                <div class="bg-red-900/30 rounded-lg p-2 md:p-3 flex-1 min-w-[70px] text-center">
                    <div class="text-gray-400 text-xs">SELL</div>
                    <div id="sellCount" class="text-xl md:text-2xl font-bold text-red-400">0</div>
                </div>
                <div class="text-center md:text-right flex-1 min-w-[80px]">
                    <div class="text-gray-400 text-xs">Last Scan</div>
                    <div id="scanTime" class="text-xs md:text-sm text-cyan-400">--</div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingDiv" class="text-center py-8 md:py-12 hidden">
            <div
                class="animate-spin inline-block w-10 h-10 md:w-12 md:h-12 border-4 border-cyan-400 border-t-transparent rounded-full">
            </div>
            <p class="mt-4 text-gray-400 text-sm md:text-base" id="loadingText">Scanning stocks...</p>
            <p class="mt-2 text-xs md:text-sm text-gray-500" id="scanProgress">Analyzing: 0 / 0 stocks</p>
        </div>

        <!-- Signals Grid - Responsive -->
        <div id="signalsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 px-4 md:px-0">
            <!-- Stock cards will be inserted here -->
        </div>

        <!-- No Signals Message -->
        <div id="noSignals" class="text-center py-8 md:py-12 hidden">
            <div class="text-5xl md:text-6xl mb-4">üì≠</div>
            <h3 class="text-lg md:text-xl text-gray-400">No signals found</h3>
            <p class="text-gray-500 mt-2 text-sm">Try adjusting filters or scan again</p>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_BASE = window.APP_CONFIG?.API_URL || window.location.origin;
        let currentSignals = [];
        let authToken = null;
        let currentUser = null;

        // Elements
        const scanBtn = document.getElementById('scanBtn');
        const limitSelect = document.getElementById('limitSelect');
        const confidenceSelect = document.getElementById('confidenceSelect');
        const actionFilter = document.getElementById('actionFilter');
        const loadingDiv = document.getElementById('loadingDiv');
        const statusBar = document.getElementById('statusBar');
        const signalsGrid = document.getElementById('signalsGrid');
        const noSignals = document.getElementById('noSignals');
        const userInfo = document.getElementById('userInfo');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmail = document.getElementById('userEmail');
        const userDashboardBanner = document.getElementById('userDashboardBanner');
        const userEmailBanner = document.getElementById('userEmailBanner');

        // Stock search elements
        const stockSearch = document.getElementById('stockSearch');
        const searchResults = document.getElementById('searchResults');
        const selectedStocksContainer = document.getElementById('selectedStocksContainer');
        const selectedStocks = document.getElementById('selectedStocks');
        const selectedCount = document.getElementById('selectedCount');
        const clearSelectedBtn = document.getElementById('clearSelectedBtn');
        const scanSelectedBtn = document.getElementById('scanSelectedBtn');

        // Stock search state
        let allStocks = [];
        let selectedStocksList = [];

        // Load stock list from API
        async function loadStockList() {
            try {
                const response = await fetch(`${API_BASE}/screener/stocks/list`);
                const data = await response.json();

                if (data.status === 'success') {
                    allStocks = data.stocks;
                    console.log(`‚úÖ Loaded ${allStocks.length} stocks for search`);
                } else {
                    console.error('Failed to load stock list:', data);
                }
            } catch (error) {
                console.error('Error loading stock list:', error);
            }
        }

        // Filter and display search results
        function filterStocks(query) {
            if (!query || query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }

            const queryLower = query.toLowerCase();
            const matches = allStocks.filter(stock => {
                return stock.short_name.toLowerCase().includes(queryLower) ||
                    stock.name.toLowerCase().includes(queryLower);
            }).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                searchResults.innerHTML = '<div class="p-3 text-gray-400 text-sm">No stocks found</div>';
                searchResults.classList.remove('hidden');
                return;
            }

            searchResults.innerHTML = matches.map(stock => `
                <div class="p-2 hover:bg-gray-600 cursor-pointer border-b border-gray-600 last:border-0"
                     onclick="selectStock('${stock.symbol}', '${stock.short_name}', '${stock.name.replace(/'/g, "\\'")}')"
                     >
                    <div class="text-sm font-semibold">${stock.short_name}</div>
                    <div class="text-xs text-gray-400">${stock.name}</div>
                </div>
            `).join('');

            searchResults.classList.remove('hidden');
        }

        // Select a stock
        function selectStock(symbol, shortName, fullName) {
            // Check if already selected
            if (selectedStocksList.some(s => s.symbol === symbol)) {
                alert('Stock already selected');
                return;
            }

            // Add to selected list
            selectedStocksList.push({ symbol, shortName, fullName });
            updateSelectedStocksDisplay();

            // Clear search
            stockSearch.value = '';
            searchResults.classList.add('hidden');
        }

        // Remove a stock from selection
        function removeStock(symbol) {
            selectedStocksList = selectedStocksList.filter(s => s.symbol !== symbol);
            updateSelectedStocksDisplay();
        }

        // Update selected stocks display
        function updateSelectedStocksDisplay() {
            if (selectedStocksList.length === 0) {
                selectedStocksContainer.classList.add('hidden');
                clearSelectedBtn.classList.add('hidden');
                return;
            }

            selectedStocksContainer.classList.remove('hidden');
            clearSelectedBtn.classList.remove('hidden');
            selectedCount.textContent = selectedStocksList.length;

            selectedStocks.innerHTML = selectedStocksList.map(stock => `
                <div class="bg-cyan-900/50 border border-cyan-500/50 rounded px-3 py-1 flex items-center gap-2 text-sm">
                    <span class="font-semibold">${stock.shortName}</span>
                    <button onclick="removeStock('${stock.symbol}')" 
                            class="text-gray-400 hover:text-white font-bold">
                        ‚úï
                    </button>
                </div>
            `).join('');
        }

        // Clear all selected stocks
        function clearAllSelected() {
            selectedStocksList = [];
            updateSelectedStocksDisplay();
        }

        // Scan selected stocks
        async function scanSelectedStocks() {
            if (selectedStocksList.length === 0) {
                alert('Please select at least one stock to scan');
                return;
            }

            if (!authToken) {
                alert('‚ùå Login required to use the stock screener.\\n\\nPlease login to scan stocks and save your results.');
                window.location.href = '/login.html';
                return;
            }

            const symbols = selectedStocksList.map(s => s.symbol).join(',');
            const minConfidence = confidenceSelect.value;

            try {
                showLoading(true);

                const url = `${API_BASE}/screener/scan?symbols=${encodeURIComponent(symbols)}&min_confidence=${minConfidence}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    currentSignals = data.signals;
                    updateStatusBar(data);
                    displaySignals();

                    if (data.saved) {
                        console.log('‚úÖ Scan results saved to your account!');
                    }
                } else if (response.status === 401 && data.detail?.error === 'fyers_auth_required') {
                    // Handle Fyers auth (same as regular scan)
                    const authModal = document.createElement('div');
                    authModal.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4">
                                <div class="text-center">
                                    <div class="text-6xl mb-4">üîê</div>
                                    <h2 class="text-xl font-bold text-cyan-400 mb-4">Fyers Authentication Required</h2>
                                    <p class="text-gray-300 mb-6">To fetch live market data and scan stocks, you need to connect your Fyers account.</p>
                                    <div class="flex gap-3 justify-center">
                                        <button onclick="openFyersAuth('${data.detail.auth_url}'); this.closest('.fixed').remove();" 
                                                class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white">
                                            Connect Fyers Account
                                        </button>
                                        <button onclick="this.closest('.fixed').remove()" 
                                                class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(authModal);
                } else if (response.status === 401) {
                    alert('Your session has expired. Please login again.');
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login.html';
                } else {
                    const errorMsg = data.detail?.message || data.detail || data.message || 'Unknown error';
                    alert('Error scanning stocks: ' + errorMsg);
                }
            } catch (error) {
                console.error('Scan error:', error);
                alert('Failed to scan stocks. Check console for details.');
            } finally {
                showLoading(false);
            }
        }

        // Stock search event listeners
        stockSearch.addEventListener('input', (e) => {
            filterStocks(e.target.value);
        });

        // Hide search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!stockSearch.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        clearSelectedBtn.addEventListener('click', clearAllSelected);
        scanSelectedBtn.addEventListener('click', scanSelectedStocks);

        // Initialize authentication
        function initAuth() {
            authToken = localStorage.getItem('auth_token');
            const userStr = localStorage.getItem('user');

            if (authToken && userStr) {
                currentUser = JSON.parse(userStr);
                userEmail.textContent = currentUser.email;
                userInfo.classList.remove('hidden');
                loginBtn.classList.add('hidden');

                // Show user dashboard banner
                if (userDashboardBanner) {
                    userDashboardBanner.classList.remove('hidden');
                    if (userEmailBanner) userEmailBanner.textContent = `(${currentUser.email})`;
                }
            } else {
                userInfo.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                if (userDashboardBanner) userDashboardBanner.classList.add('hidden');
            }
        }

        // Logout
        logoutBtn.addEventListener('click', async () => {
            if (authToken) {
                try {
                    await fetch(`${API_BASE}/api/auth/logout?authorization=Bearer ${authToken}`, {
                        method: 'POST'
                    });
                } catch (error) {
                    console.log('Logout error:', error);
                }
            }

            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            window.location.reload();
        });

        // Scan stocks
        async function scanStocks() {
            // Check authentication first
            if (!authToken) {
                alert('‚ùå Login required to use the stock screener.\n\nPlease login to scan stocks and save your results.');
                window.location.href = '/login.html';
                return;
            }

            const limit = limitSelect.value;
            const minConfidence = confidenceSelect.value;

            try {
                showLoading(true);

                // Build URL and send auth token in header (best practice)
                const url = `${API_BASE}/screener/scan?limit=${limit}&min_confidence=${minConfidence}&randomize=true`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    currentSignals = data.signals;
                    updateStatusBar(data);
                    displaySignals();

                    // Show save status
                    if (data.saved) {
                        console.log('‚úÖ Scan results saved to your account!');
                    } else {
                        console.log('‚ö†Ô∏è Scan completed but failed to save results');
                    }
                } else if (response.status === 401 && data.detail?.error === 'fyers_auth_required') {
                    // Fyers authentication required
                    const authModal = document.createElement('div');
                    authModal.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4">
                                <div class="text-center">
                                    <div class="text-6xl mb-4">üîê</div>
                                    <h2 class="text-xl font-bold text-cyan-400 mb-4">Fyers Authentication Required</h2>
                                    <p class="text-gray-300 mb-6">To fetch live market data and scan stocks, you need to connect your Fyers account.</p>
                                    <div class="flex gap-3 justify-center">
                                        <button onclick="openFyersAuth('${data.detail.auth_url}'); this.closest('.fixed').remove();" 
                                                class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white">
                                            Connect Fyers Account
                                        </button>
                                        <button onclick="this.closest('.fixed').remove()" 
                                                class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(authModal);
                } else if (response.status === 401 && data.detail?.error === 'fyers_token_expired') {
                    // Fyers token expired
                    const expiredModal = document.createElement('div');
                    expiredModal.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4">
                                <div class="text-center">
                                    <div class="text-6xl mb-4">‚è∞</div>
                                    <h2 class="text-xl font-bold text-yellow-400 mb-4">Authentication Expired</h2>
                                    <p class="text-gray-300 mb-6">Your Fyers authentication has expired (tokens last 24 hours). Please re-authenticate to continue.</p>
                                    <div class="flex gap-3 justify-center">
                                        <button onclick="openFyersAuth('${data.detail.auth_url}'); this.closest('.fixed').remove();" 
                                                class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-white">
                                            Re-authenticate
                                        </button>
                                        <button onclick="this.closest('.fixed').remove()" 
                                                class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(expiredModal);
                } else if (response.status === 401) {
                    // Supabase authentication expired
                    alert('Your session has expired. Please login again.');
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login.html';
                } else {
                    // Other errors
                    const errorMsg = data.detail?.message || data.detail || data.message || 'Unknown error';
                    alert('Error scanning stocks: ' + errorMsg);
                }
            } catch (error) {
                console.error('Scan error:', error);
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    alert('Session expired. Please login again.');
                    window.location.href = '/login.html';
                } else {
                    alert('Failed to scan stocks. Check console for details.');
                }
            } finally {
                showLoading(false);
            }
        }

        // Update status bar
        function updateStatusBar(data) {
            document.getElementById('stocksScanned').textContent = data.stocks_scanned || 0;
            document.getElementById('totalSignals').textContent = data.total_signals;
            document.getElementById('buyCount').textContent = data.buy_signals;
            document.getElementById('sellCount').textContent = data.sell_signals;
            document.getElementById('scanTime').textContent = new Date(data.scan_time).toLocaleTimeString();
            statusBar.classList.remove('hidden');
        }

        // Display signals
        function displaySignals() {
            const action = actionFilter.value;
            let signals = [];

            // Safely get buy and sell arrays with fallback to empty arrays
            const buySignals = Array.isArray(currentSignals?.buy) ? currentSignals.buy : [];
            const sellSignals = Array.isArray(currentSignals?.sell) ? currentSignals.sell : [];

            if (action === 'all') {
                signals = [...buySignals, ...sellSignals];
            } else if (action === 'BUY') {
                signals = buySignals;
            } else {
                signals = sellSignals;
            }

            // Sort by confidence
            signals.sort((a, b) => b.confidence - a.confidence);

            if (signals.length === 0) {
                signalsGrid.innerHTML = '';
                noSignals.classList.remove('hidden');
                return;
            }

            noSignals.classList.add('hidden');
            signalsGrid.innerHTML = signals.map(signal => createStockCard(signal)).join('');
        }

        // Create stock card - Mobile optimized
        function createStockCard(signal) {
            const isBuy = signal.action === 'BUY';
            const borderColor = isBuy ? 'border-green-500' : 'border-red-500';
            const actionBg = isBuy ? 'bg-green-600' : 'bg-red-600';
            const confidence = signal.confidence || 0;
            const confidenceColor = confidence >= 80 ? 'text-green-400' : confidence >= 70 ? 'text-cyan-400' : 'text-yellow-400';
            const confidenceBadge = confidence >= 80 ? 'HIGH' : confidence >= 70 ? 'MODERATE' : 'LOW';

            // Safe number formatter
            const safeNum = (val, decimals = 2) => {
                if (val === null || val === undefined || isNaN(val)) return '--';
                return Number(val).toFixed(decimals);
            };

            // Safe percentage calculator
            const safePct = (target, current) => {
                if (!target || !current || current === 0) return '--';
                return ((target / current - 1) * 100).toFixed(1);
            };

            const currentPrice = signal.current_price || 0;
            const changePct = signal.change_pct || 0;
            const changeColor = changePct >= 0 ? 'text-green-400' : 'text-red-400';

            const targets = signal.targets || {};
            const indicators = signal.indicators || {};
            const reasons = signal.reasons || [];

            return `
                <div class="signal-card bg-gray-800 rounded-lg border-2 ${borderColor} p-3 md:p-4 hover:bg-gray-750 transition">
                    <!-- Header - Compact -->
                    <div class="flex justify-between items-start mb-2 md:mb-3">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base md:text-lg font-bold truncate">${signal.name || 'Unknown'}</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400">‚Çπ${safeNum(currentPrice)}</span>
                                <span class="${changeColor} text-xs">${changePct > 0 ? '+' : ''}${safeNum(changePct, 1)}%</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="${actionBg} px-2 md:px-3 py-1 rounded font-semibold text-xs md:text-sm">
                                ${signal.action}
                            </span>
                            <span class="text-xs ${confidenceColor}">${confidenceBadge}</span>
                        </div>
                    </div>

                    <!-- Confidence Bar -->
                    <div class="mb-2 md:mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Confidence</span>
                            <span class="${confidenceColor} font-bold">${safeNum(confidence, 0)}%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="${isBuy ? 'bg-green-500' : 'bg-red-500'} h-2 rounded-full transition-all" style="width: ${Math.min(confidence, 100)}%"></div>
                        </div>
                    </div>

                    <!-- Targets - Compact -->
                    <div class="border-t border-gray-700 pt-2 mb-2">
                        <div class="grid grid-cols-3 gap-1 md:gap-2 text-xs">
                            <div class="bg-green-900/30 rounded p-1.5 md:p-2 text-center">
                                <div class="text-gray-400 text-[10px] md:text-xs">T1</div>
                                <div class="font-semibold text-green-400">‚Çπ${safeNum(targets.target_1, 0)}</div>
                                <div class="text-green-300 text-[10px]">+${safePct(targets.target_1, currentPrice)}%</div>
                            </div>
                            <div class="bg-green-900/40 rounded p-1.5 md:p-2 text-center">
                                <div class="text-gray-400 text-[10px] md:text-xs">T2</div>
                                <div class="font-semibold text-green-400">‚Çπ${safeNum(targets.target_2, 0)}</div>
                                <div class="text-green-300 text-[10px]">+${safePct(targets.target_2, currentPrice)}%</div>
                            </div>
                            <div class="bg-red-900/30 rounded p-1.5 md:p-2 text-center">
                                <div class="text-gray-400 text-[10px] md:text-xs">SL</div>
                                <div class="font-semibold text-red-400">‚Çπ${safeNum(targets.stop_loss, 0)}</div>
                                <div class="text-red-300 text-[10px]">${safePct(targets.stop_loss, currentPrice)}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicators - Collapsible on mobile -->
                    <details class="border-t border-gray-700 pt-2">
                        <summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-300">
                            Technical Details ‚ñº
                        </summary>
                        <div class="grid grid-cols-2 gap-2 text-xs mt-2">
                            <div>
                                <span class="text-gray-500">RSI:</span>
                                <span class="font-semibold">${safeNum(indicators.rsi, 1)}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Momentum:</span>
                                <span class="font-semibold ${(indicators.momentum_5d || 0) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${(indicators.momentum_5d || 0) > 0 ? '+' : ''}${safeNum(indicators.momentum_5d, 1)}%
                                </span>
                            </div>
                            <div>
                                <span class="text-gray-500">SMA 5:</span>
                                <span class="font-semibold">‚Çπ${safeNum(indicators.sma_5)}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Volume:</span>
                                <span class="font-semibold ${indicators.volume_surge ? 'text-orange-400' : ''}">
                                    ${indicators.volume_surge ? 'üî• SURGE' : 'Normal'}
                                </span>
                            </div>
                        </div>
                    </details>

                    <!-- Reasons - Compact -->
                    <div class="border-t border-gray-700 pt-3">
                        <div class="text-xs text-gray-400 mb-2">SIGNAL REASONS</div>
                        <div class="space-y-1">
                            ${reasons.map(reason => `
                                <div class="text-xs bg-gray-700/50 rounded px-2 py-1">${reason}</div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Show/hide loading
        function showLoading(show) {
            loadingDiv.classList.toggle('hidden', !show);
            signalsGrid.classList.toggle('hidden', show);
            statusBar.classList.toggle('hidden', show);
        }

        // Open Fyers authentication in popup
        function openFyersAuth(authUrl) {
            // Get fresh auth token from localStorage
            const currentAuthToken = localStorage.getItem('auth_token');
            console.log('üöÄ Opening Fyers auth popup with authToken:', currentAuthToken ? 'Present' : 'Missing');

            if (!currentAuthToken) {
                alert('Please login to TradeWise first!');
                window.location.href = '/login.html';
                return;
            }

            // Check if we're running on the same domain (ngrok)
            const isNgrokDomain = window.location.hostname.includes('ngrok-free.app');

            if (isNgrokDomain) {
                console.log('üåê Using ngrok domain - same-origin popup communication enabled');
                // For same-domain, we can pass the auth token via URL fragment for easier access
                const authUrlWithToken = `${authUrl}#token=${currentAuthToken}`;
                const popup = window.open(authUrlWithToken, 'fyersAuth', 'width=600,height=700,scrollbars=yes,resizable=yes');

                // Listen for messages from popup (same-origin, should work perfectly)
                const messageHandler = (event) => {
                    console.log('üì® Received message in parent:', event.data);

                    if (event.data.type === 'get_auth_token') {
                        console.log('üîë Popup requesting auth token');
                        popup.postMessage({
                            type: 'auth_token_response',
                            token: currentAuthToken
                        }, '*');
                        console.log('üì§ Sent auth token response to popup');
                    } else if (event.data.type === 'fyers_auth_success') {
                        console.log('üéâ Fyers authentication successful!');
                        checkFyersAuth(); // Refresh auth status
                        window.removeEventListener('message', messageHandler);
                    } else if (event.data.type === 'fyers_auth_error') {
                        console.error('‚ùå Fyers authentication failed:', event.data.error);
                        window.removeEventListener('message', messageHandler);
                    }
                };

                window.addEventListener('message', messageHandler);
                console.log('üëÇ Added message listener for same-origin popup communication');

                // Clean up if popup is closed manually
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        window.removeEventListener('message', messageHandler);
                        console.log('üö™ Popup closed, cleaned up listeners');
                    }
                }, 1000);
            } else {
                console.log('üè† Using localhost domain - opening popup with cross-origin fallback');
                const popup = window.open(authUrl, 'fyersAuth', 'width=600,height=700,scrollbars=yes,resizable=yes');

                // For localhost, use the existing cross-origin handling
                const messageHandler = (event) => {
                    console.log('üì® Received message in parent:', event.data);

                    if (event.data.type === 'get_auth_token') {
                        console.log('üîë Popup requesting auth token');
                        popup.postMessage({
                            type: 'auth_token_response',
                            token: currentAuthToken
                        }, '*');
                        console.log('üì§ Sent auth token response to popup');
                    } else if (event.data.type === 'fyers_auth_success') {
                        console.log('üéâ Fyers authentication successful!');
                        checkFyersAuth(); // Refresh auth status
                        window.removeEventListener('message', messageHandler);
                    } else if (event.data.type === 'fyers_auth_error') {
                        console.error('‚ùå Fyers authentication failed:', event.data.error);
                        window.removeEventListener('message', messageHandler);
                    }
                };

                window.addEventListener('message', messageHandler);
                console.log('üëÇ Added message listener for cross-origin popup communication');

                // Clean up if popup is closed manually
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        window.removeEventListener('message', messageHandler);
                        console.log('üö™ Popup closed, cleaned up listeners');
                    }
                }, 1000);
            }
        }

        // Check Fyers authentication status
        async function checkFyersAuth() {
            if (!authToken) {
                console.log('‚ö†Ô∏è No auth token available for Fyers check');
                return;
            }

            try {
                console.log('üîç Checking Fyers auth status...');
                const response = await fetch(`${API_BASE}/api/fyers/token`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const authStatusDiv = document.getElementById('authStatus');
                const authStatusText = document.getElementById('authStatusText');
                const fyersAuthBtn = document.getElementById('fyersAuthBtn');

                console.log('üì° Fyers token check response:', response.status);

                if (response.ok) {
                    // Fyers token exists and is valid
                    console.log('‚úÖ Fyers token found');
                    authStatusDiv.className = 'bg-gray-800 rounded-lg p-4 mb-6 border-l-4 border-green-400';
                    authStatusText.innerHTML = '‚úÖ Market data access ready - your Fyers account is connected.';
                    fyersAuthBtn.classList.add('hidden');
                } else if (response.status === 401) {
                    // TradeWise session expired - need to re-login
                    console.log('‚ùå TradeWise session expired (401)');
                    authStatusDiv.className = 'bg-gray-800 rounded-lg p-4 mb-6 border-l-4 border-red-400';
                    authStatusText.innerHTML = '‚ùå Session expired - please login again to TradeWise.';
                    fyersAuthBtn.classList.add('hidden');
                    // Clear expired token
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user');
                } else if (response.status === 404) {
                    // No Fyers token - need to connect Fyers
                    console.log('‚ö†Ô∏è No Fyers token found (404) - need to authenticate with Fyers');
                    authStatusDiv.className = 'bg-gray-800 rounded-lg p-4 mb-6 border-l-4 border-yellow-400';
                    authStatusText.innerHTML = '‚ö†Ô∏è Market data access required - click to connect your Fyers account.';
                    fyersAuthBtn.classList.remove('hidden');
                    setupFyersAuthButton();
                } else {
                    // Other error
                    console.log('‚ùì Unknown response status:', response.status);
                    authStatusDiv.className = 'bg-gray-800 rounded-lg p-4 mb-6 border-l-4 border-yellow-400';
                    authStatusText.innerHTML = '‚ö†Ô∏è Could not check Fyers status. Please try again.';
                    fyersAuthBtn.classList.remove('hidden');
                    setupFyersAuthButton();
                }
            } catch (error) {
                console.error('‚ùå Error checking Fyers auth:', error);
            }
        }

        // Setup Fyers auth button click handler
        function setupFyersAuthButton() {
            const fyersAuthBtn = document.getElementById('fyersAuthBtn');
            fyersAuthBtn.onclick = async () => {
                try {
                    const response = await fetch(`${API_BASE}/auth/url`);
                    const data = await response.json();

                    // Open in popup for better UX
                    const popup = window.open(
                        data.auth_url,
                        'fyersAuth',
                        'width=600,height=700,scrollbars=yes,resizable=yes'
                    );

                    // Check for popup completion
                    const checkClosed = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(checkClosed);
                            // Refresh auth status after popup closes
                            setTimeout(() => checkFyersAuth(), 1000);
                        }
                    }, 1000);

                } catch (error) {
                    console.error('Auth error:', error);
                    alert('Failed to start authentication. Please try again.');
                }
            };
        }

        // Event listeners
        scanBtn.addEventListener('click', scanStocks);
        refreshBtn.addEventListener('click', scanStocks);
        actionFilter.addEventListener('change', displaySignals);

        // Initialize authentication on page load
        initAuth();

        // Load stock list for search functionality
        loadStockList();

        // Check Fyers auth status
        if (authToken) {
            checkFyersAuth();
        }

        // Redirect to login if not authenticated
        if (!authToken) {
            console.log('‚ö†Ô∏è Authentication required to use Stock Screener');
            alert('üîí Stock Screener requires authentication.\n\nPlease login to access the scanner and save your results.');
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 1500);
        }

        // Auto-refresh disabled - manual scan only
        // To enable auto-refresh, uncomment the code below:
        /*
        setInterval(() => {
            if (currentSignals.buy || currentSignals.sell) {
                console.log('Auto-refreshing signals...');
                scanStocks();
            }
        }, 5 * 60 * 1000);
        */

        // Check for scan ID in URL parameter
        async function loadScanFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const scanId = urlParams.get('scan') || localStorage.getItem('view_scan_id');

            if (scanId) {
                console.log('Loading scan:', scanId);
                localStorage.removeItem('view_scan_id'); // Clear after reading

                if (!authToken) {
                    alert('Please login to view saved scans');
                    return;
                }

                try {
                    // Note: We would need a new endpoint to fetch a specific scan
                    // For now, we'll fetch latest and check if it matches
                    const response = await fetch(`${API_BASE}/screener/history?limit=10`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const scan = data.scans.find(s => s.scan_id === scanId);

                        if (scan) {
                            // Show notification that this is a saved scan
                            const statusBar = document.querySelector('.bg-gray-800.rounded-lg');
                            if (statusBar) {
                                const notice = document.createElement('div');
                                notice.className = 'bg-blue-900/50 border border-blue-500/50 rounded p-3 mb-4 text-sm';
                                notice.innerHTML = `
                                    <span class="text-blue-400">üìã Viewing saved scan from ${new Date(scan.scan_time).toLocaleString()}</span>
                                    <button onclick="this.parentElement.remove()" class="float-right text-gray-400 hover:text-white">‚úï</button>
                                `;
                                statusBar.parentElement.insertBefore(notice, statusBar);
                            }

                            console.log('‚úÖ Loaded saved scan:', scan);
                            // You can add more logic here to display the scan results
                        }
                    }
                } catch (error) {
                    console.error('Error loading scan:', error);
                }
            }
        }

        // Load scan if URL parameter is present
        if (authToken) {
            loadScanFromURL();
        }

        // Initial message
        if (authToken) {
            console.log('‚úÖ Logged in. Scan results will be automatically saved to your account.');
            console.log('Stock Screener ready. Click "Scan Stocks" to begin.');
        }
    </script>
</body>

</html>