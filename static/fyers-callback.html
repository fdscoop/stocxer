<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeWise - Fyers Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center">
    <div class="max-w-md mx-auto p-6 bg-gray-800 rounded-lg shadow-xl">
        <div class="text-center">
            <div id="message">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto"></div>
                <p class="mt-4 text-gray-300">Processing Fyers authentication...</p>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Get API URL with fallback for old deployments
        let API_BASE = window.APP_CONFIG?.API_URL || window.location.origin;
        
        // TEMPORARY FIX: If config.js hasn't deployed yet and we're getting old Render URL
        if (API_BASE.includes('stocxer-ai.onrender.com') || API_BASE === window.location.origin) {
            API_BASE = 'https://stocxer-484044910258.europe-west1.run.app';
            console.log('üîß Using Google Cloud Run fallback URL:', API_BASE);
        }

        async function handleCallback() {
            const message = document.getElementById('message');
            
            try {
                // Get auth code from URL
                const urlParams = new URLSearchParams(window.location.search);
                const authCode = urlParams.get('auth_code');
                const state = urlParams.get('state');
                
                if (!authCode) {
                    throw new Error('No authorization code received from Fyers');
                }
                
                console.log('üîÑ Processing Fyers callback with auth_code:', authCode.substring(0, 20) + '...');
                
                // Check if this is a popup window
                const isPopup = window.opener && window.opener !== window;
                const isNgrokDomain = window.location.hostname.includes('ngrok-free.app');
                let authToken = null;
                
                // First, try to get auth token from URL fragment (for same-domain ngrok)
                const tokenFromFragment = window.location.hash.match(/token=([^&]+)/)?.[1];
                if (tokenFromFragment) {
                    authToken = tokenFromFragment;
                    console.log('üì® Found auth token in URL fragment (same-domain)');
                }
                
                // Fallback: try current window's localStorage
                if (!authToken) {
                    authToken = localStorage.getItem('auth_token');
                    console.log('üì® Trying localStorage for auth token');
                }
                
                if (!authToken && isPopup) {
                    if (isNgrokDomain) {
                        console.log('ü™ü Running in popup on ngrok domain, requesting from parent (same-origin)...');
                        
                        // For same-domain (ngrok), this should work reliably
                        try {
                            window.opener.postMessage({ type: 'get_auth_token' }, '*');
                            
                            // Wait for response from parent window
                            authToken = await new Promise((resolve, reject) => {
                                const timeout = setTimeout(() => {
                                    reject(new Error('Timeout waiting for auth token (same-domain)'));
                                }, 3000); // Shorter timeout for same-domain
                                
                                const messageHandler = (event) => {
                                    if (event.data.type === 'auth_token_response') {
                                        clearTimeout(timeout);
                                        window.removeEventListener('message', messageHandler);
                                        console.log('üì® Received auth token from parent window (same-domain)');
                                        resolve(event.data.token);
                                    }
                                };
                                
                                window.addEventListener('message', messageHandler);
                            });
                        } catch (e) {
                            console.log('‚ùå Failed to get token from parent (same-domain):', e.message);
                            authToken = null;
                        }
                    } else {
                        console.log('ü™ü Running in popup on localhost, trying cross-origin methods...');
                        
                        // Try to get from URL fragment or query params if passed
                        const tokenFromUrl = urlParams.get('token');
                        if (tokenFromUrl) {
                            authToken = tokenFromUrl;
                            console.log('üì® Found auth token in URL params');
                        }
                        
                        // If still no token, try sessionStorage
                        if (!authToken) {
                            authToken = sessionStorage.getItem('auth_token');
                            console.log('üì® Trying sessionStorage for auth token');
                        }
                        
                        // Last resort: try to communicate with parent (may fail due to CORS)
                        if (!authToken) {
                            try {
                                console.log('üì® Trying to get token from parent window (cross-origin)...');
                                window.opener.postMessage({ type: 'get_auth_token' }, '*');
                                
                                // Wait for response from parent window with shorter timeout
                                authToken = await new Promise((resolve, reject) => {
                                    const timeout = setTimeout(() => {
                                        reject(new Error('CROSS_ORIGIN_BLOCKED'));
                                    }, 2000); // Reduced timeout
                                    
                                    const messageHandler = (event) => {
                                        if (event.data.type === 'auth_token_response') {
                                            clearTimeout(timeout);
                                            window.removeEventListener('message', messageHandler);
                                            console.log('üì® Received auth token from parent window (cross-origin)');
                                            resolve(event.data.token);
                                        }
                                    };
                                    
                                    window.addEventListener('message', messageHandler);
                                });
                            } catch (e) {
                                console.log('‚ùå Cross-origin communication blocked:', e.message);
                                authToken = null;
                            }
                        }
                    }
                }
                
                if (!authToken) {
                    console.log('‚ùå No auth token found, redirecting to get token...');
                    
                    // Redirect to a special endpoint that will handle the callback with a fresh auth token
                    const callbackUrl = `${window.location.origin}/auth/callback-redirect?auth_code=${authCode}&state=${state || ''}`;
                    console.log('üîÑ Redirecting to callback endpoint:', callbackUrl);
                    window.location.href = callbackUrl;
                    return;
                }
                
                console.log('‚úÖ Auth token found, proceeding with callback...');
                message.innerHTML = '<div class="text-blue-600">Connecting your Fyers account...</div>';
                
                // Send to callback endpoint
                const response = await fetch(`${API_BASE}/auth/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        auth_code: authCode,
                        state: state
                    })
                });
                
                const data = await response.json();
                console.log('üì° Callback response:', data);
                
                if (response.ok) {
                    console.log('üéâ Authentication successful!');
                    message.innerHTML = `
                        <div class="space-y-4">
                            <div class="text-green-400 text-5xl">‚úÖ</div>
                            <h2 class="text-xl font-bold text-green-400">Authentication Successful!</h2>
                            <p class="text-gray-300">Your Fyers account has been connected successfully.</p>
                            ${isPopup ? '<p class="text-sm text-gray-400">This window will close automatically...</p>' : ''}
                            <button onclick="goToScreener()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded">
                                Go to Stock Screener
                            </button>
                        </div>
                    `;
                    
                    // Notify parent window if this is a popup
                    if (isPopup) {
                        try {
                            window.opener.postMessage({ 
                                type: 'fyers_auth_success',
                                data: data 
                            }, '*');
                            
                            // Auto-close after success
                            setTimeout(() => {
                                console.log('üö™ Closing popup window...');
                                window.close();
                            }, 2000);
                        } catch (e) {
                            console.error('Could not notify parent window:', e);
                        }
                    }
                } else {
                    throw new Error(data.detail || data.message || 'Authentication failed');
                }
                
            } catch (error) {
                console.error('‚ùå Callback error:', error);
                let errorMessage;
                
                if (error.message === 'CROSS_ORIGIN_BLOCKED' || error.message.includes('Cross-origin')) {
                    errorMessage = `
                        <div class="space-y-4">
                            <div class="text-yellow-400 text-5xl">‚ö†Ô∏è</div>
                            <h2 class="text-xl font-bold text-yellow-400">Cross-Origin Issue</h2>
                            <div class="text-gray-300 space-y-2">
                                <p>Authentication popup cannot communicate with parent window due to security restrictions.</p>
                                <p>Please try authenticating directly in the main window instead.</p>
                            </div>
                            <div class="flex gap-3 justify-center">
                                <button onclick="goToScreener()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded">
                                    Try Direct Authentication
                                </button>
                                <button onclick="window.close()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                                    Close Window
                                </button>
                            </div>
                        </div>
                    `;
                } else if (error.message.includes('session has expired') || error.message.includes('Invalid token') || error.message.includes('login again')) {
                    // TradeWise session expired - clear local storage and redirect to login
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user');
                    errorMessage = `
                        <div class="space-y-4">
                            <div class="text-yellow-400 text-5xl">üîÑ</div>
                            <h2 class="text-xl font-bold text-yellow-400">Session Expired</h2>
                            <div class="text-gray-300 space-y-2">
                                <p>Your TradeWise session has expired.</p>
                                <p>Please login again to continue with Fyers authentication.</p>
                            </div>
                            <div class="flex gap-3 justify-center">
                                <a href="/login.html" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-decoration-none">
                                    Login to TradeWise
                                </a>
                                <button onclick="window.close()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                                    Close Window
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    errorMessage = `
                        <div class="space-y-4">
                            <div class="text-red-400 text-5xl">‚ùå</div>
                            <h2 class="text-xl font-bold text-red-400">Authentication Failed</h2>
                            <p class="text-gray-300">${error.message}</p>
                            <div class="flex gap-3 justify-center">
                                <button onclick="window.close()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                                    Close Window
                                </button>
                                <a href="/login.html" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-decoration-none">
                                    Login to TradeWise
                                </a>
                            </div>
                        </div>
                    `;
                }
                
                message.innerHTML = errorMessage;
                
                // Notify parent window of error if this is a popup
                if (window.opener) {
                    try {
                        window.opener.postMessage({ 
                            type: 'fyers_auth_error',
                            error: error.message 
                        }, '*');
                    } catch (e) {
                        console.error('Could not notify parent window of error:', e);
                    }
                }
            }
        }
        
        function goToScreener() {
            window.location.href = '/screener.html';
        }
        
        // Run callback handler on page load
        document.addEventListener('DOMContentLoaded', handleCallback);
    </script>
</body>
</html>